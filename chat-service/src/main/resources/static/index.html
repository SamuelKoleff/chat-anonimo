<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Chat Privado - Matchmaking</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #fafafa; padding: 2rem; }
        .container { max-width: 600px; margin: auto; background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, button { padding: 0.5rem; margin: 0.25rem 0; width: 100%; }
        #messages { border: 1px solid #ccc; height: 200px; overflow-y: auto; margin-top: 1rem; padding: 0.5rem; background: #f8f8f8; }
        .msg { margin-bottom: 0.5rem; }
        .msg.you { text-align: right; color: blue; }
    </style>
</head>
<body>
<div class="container">
    <h2>üí¨ Chat Privado (Matchmaking)</h2>

    <h3>1Ô∏è‚É£ Crear un match</h3>
    <input type="text" id="user1" placeholder="Usuario 1 (ID o nombre)">
    <input type="text" id="user2" placeholder="Usuario 2 (ID o nombre)">
    <button onclick="createMatch()">Crear Match</button>

    <h3>2Ô∏è‚É£ Conectarse al match</h3>
    <input type="text" id="matchId" placeholder="Match ID">
    <input type="text" id="currentUser" placeholder="Tu nombre de usuario">
    <button onclick="connectToRoom()">Conectar</button>

    <h3>3Ô∏è‚É£ Chat</h3>
    <div id="messages"></div>
    <input type="text" id="msg" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">Enviar</button>
</div>

<script>
    let stompClient = null;
    let connectedMatchId = null;
    let currentUser = null;

    // URL base del backend (ajustada)
    const BASE_URL = "http://localhost:8080/chat-service";

    async function createMatch() {
        const user1 = document.getElementById("user1").value;
        const user2 = document.getElementById("user2").value;

        const response = await fetch(`${BASE_URL}/matches`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user1, user2 })
        });

        const data = await response.json();
        document.getElementById("matchId").value = data.matchId;

        alert(`Match creado ‚úÖ\nMatch ID: ${data.matchId}\nRoom: ${data.room}`);
    }

    function connectToRoom() {
        const matchId = document.getElementById("matchId").value;
        currentUser = document.getElementById("currentUser").value;

        if (!matchId || !currentUser) {
            alert("Completa Match ID y Usuario actual");
            return;
        }

        // üëá se ajusta el endpoint del socket
        const socket = new SockJS(`${BASE_URL}/gs-guide-websocket`);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, (frame) => {
            console.log("Conectado:", frame);
            connectedMatchId = matchId;

            stompClient.subscribe(`/topic/match/${matchId}`, (msg) => {
                const message = JSON.parse(msg.body);
                showMessage(message.sender, message.content);
            });

            alert("Conectado al match ‚úÖ");
        });
    }

    function sendMessage() {
        const msg = document.getElementById("msg").value.trim();
        if (!msg || !stompClient || !connectedMatchId) return;

        const message = { sender: currentUser, content: msg };
        stompClient.send(`/app/match/${connectedMatchId}`, {}, JSON.stringify(message));

        showMessage(currentUser, msg);
        document.getElementById("msg").value = "";
    }

    function showMessage(sender, content) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "msg" + (sender === currentUser ? " you" : "");
        msgDiv.textContent = `${sender}: ${content}`;
        const messages = document.getElementById("messages");
        messages.appendChild(msgDiv);
        messages.scrollTop = messages.scrollHeight;
    }
</script>
</body>
</html>
